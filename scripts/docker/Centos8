FROM centos:8

# Enable epel & power tools repositories
RUN yum -y install  epel-release dnf-plugins-core && yum config-manager --set-enabled powertools

RUN yum -y install \
    blas-devel \
    boost-devel \
    cfitsio-devel \
    cmake \
    fftw-devel \
    gcc-c++ \
    git \
    gsl-devel \
    hdf5-devel \
    lapack-devel \
    lua-devel \
    make \
    python3 \
    python3-devel \
    libarchive
# Libarchive is not required by wsclean, but because of a RHEL8 issue needs to be manually installed to use cmake

# casacore dependencies & compilation
RUN \
  yum -y install \
     bison \
     bzip2 \
     flex \
     gcc-gfortran \
     ncurses-devel \
     python3-libs \
     readline-devel \
     wcslib-devel \
     wget \
  && \
  mkdir /external && \
  cd /external && \
  git clone https://github.com/casacore/casacore.git && \
  cd /external/casacore && \
  git checkout v3.3.0 && \
  mkdir build && \
  cd build && \
  cmake .. -DBUILD_PYTHON=OFF -DBUILD_TESTING=OFF && \
  make -j`nproc --all` && \
  make install -j`nproc --all`

ADD . /src
WORKDIR /src

RUN mkdir /build && cd /build && cmake ../src

RUN cd /build && make -j`nproc --all` && make install

RUN wsclean --version
